# file: roles/wordpress-instance/tasks/main.yml
#
# What to do to install and configure a WordPress instance
#
# Variables:: (in addition to those defined or documented in
#              ../vars/*.yml)

- include_vars: wp-destructive.yml

- name: "Backup"
  include: "backup.yml"
  tags:
    - never  # That is, skip unless "-t backup" or "-t wipe" is
             # passed on the command line
    - wipe
    - backup

- name: "Wipe"
  include: "wipe.yml"
  tags:
    - never
    - wipe

- name: Check whether WordPress is already installed
  stat:
    path: "{{ wp_path_config_php }}"
  register: _wp_config_php_stat

- name: "{{ 'Recreate' if 'wipe' in ansible_run_tags else 'Create' }}"
  include: "create.yml"
  when: not _wp_config_php_stat.stat.exists

- name: Restore
  include: "restore.yml"
  when: wp_restore_from is defined
  tags:
    - never
    - restore-from-backup

- name: Check that WordPress is working
  command: "{{ wp_cli_command }} eval '1;'"
  changed_when: false

- name: Configure
  include: "configure.yml"
  when: wp_can.write_data
  tags: configure

#################################################################
# Special-purpose tasks
#################################################################

# These tasks are used in "ventilation" (site move) workflows only
- name: "Dump WXR"
  include: "dump.yml"
  tags:
    - never
    - dump
- name: "Undump WXR"
  include: "undump.yml"
  tags:
    - never
    - undump
