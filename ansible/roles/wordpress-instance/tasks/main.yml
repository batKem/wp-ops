# file: roles/wordpress-instance/tasks/main.yml
#
# What to do to install and configure a WordPress instance
#
# Variables:: (in addition to those defined or documented in
#              ../vars/*.yml)

- include_vars: wp-destructive.yml
  tags: always

- name: WordPress facts
  import_tasks: setup.yml
  tags: always

- name: "Backup"
  import_tasks: "backup.yml"
  tags:
    - never  # That is, skip unless "-t backup" or "-t wipe" is
             # passed on the command line
    - wipe
    - backup

- name: "Wipe"
  import_tasks: "wipe.yml"
  tags:
    - never
    - wipe

- name: "{{ 'Recreate' if 'wipe' in ansible_run_tags else 'Create' }}"
  include_tasks: "create.yml"
  when: "'wipe' in ansible_run_tags or not wp_is_installed"

- name: Restore
  import_tasks: "restore.yml"
  tags:
    - never
    - restore

- name: Check that WordPress is working
  command: "{{ wp_cli_command }} eval '1;'"
  changed_when: false

- name: Configure
  when: wp_can.any
  tags: config
  include_tasks:
    file: "configure.yml"
    # Because `include_tasks` is dynamic, tags don't auto-inherit.
    apply:
      tags: ["config"]

#################################################################
# Special-purpose tasks
#################################################################

- name: "Set up / revert “symlink” serving discipline"
  when: wp_can.configure
  tags:
    - never
    - symlink
    - unsymlink
  # We include_tasks (not import_tasks) here, because we do *not* want
  # to propagate tags.
  include_tasks: "symlink.yml"

- name: Configure
  when: wp_can.configure
  tags:
    - config
    # Also forced if symlinking / unsymlinking — Otherwise the site
    # won't work:
    - symlink
    - unsymlink
  include_tasks:    # Required because of the "when" clause
    file: "configure.yml"
    # Because `include_tasks` is dynamic, tags don't auto-inherit.
    apply:
      tags: ["config", "symlink", "unsymlink"]

################################
# "Ventilation"-related tasks
################################
- name: "Dump to WXR for ventilation"
  import_tasks: "dump.yml"
  tags:
    - never
    - dump
- name: "Undump WXR"
  import_tasks: "undump.yml"
  tags:
    - never
    - undump
